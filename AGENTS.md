# AGENTS.md - Oasis 项目全局开发规则

> **本文件用于确保 AI 助手（Gemini/Claude/GPT）在此项目中始终遵循架构原则。**
> 请勿删除或修改本文件。

---

## 一、核心架构原则 (铁律)

```
┌────────────────────────────────────────────────────────────┐
│                     LLM 决策层                              │
│  (agent_behavior.py)                                       │
│  ✅ 生成意愿 (想买/想卖/观望)                              │
│  ✅ 选择行为 (出价/接受/拒绝/退出)                        │
│  ✅ 生成话术 (谈判语言)                                   │
│  ✅ 选择目标 (挑选房产、决定卖哪套)                       │
└────────────────────────────────────────────────────────────┘
                          │
                          ▼ 决策输出 (JSON)
┌────────────────────────────────────────────────────────────┐
│                     代码规则层                              │
│  (transaction_engine.py, mortgage_system.py)               │
│  ✅ 验证资金 (买得起吗？)                                 │
│  ✅ 执行交割 (转账、过户)                                 │
│  ✅ 更新环境 (市场价格、Agent状态)                       │
│  ✅ 流程控制 (下一步是什么？)                             │
│  ❌ 禁止: 生成意愿、替Agent做选择                        │
└────────────────────────────────────────────────────────────┘
```

### 1.1 具体边界

| 行为类型 | 正确归属 | 错误归属 | 说明 |
|:---------|:---------|:---------|:-----|
| "这个月是否买房" | LLM | ❌ 代码概率 | `calculate_activation_probability` 仅做预筛，不做决策 |
| "现金紧张→卖房" | LLM (上下文提示) | ❌ 代码强制 | 将约束转为Prompt提示，而非Hard Constraint |
| "选哪套房买" | LLM | ❌ `price.sort()[0]` | 不要用代码替Agent选择 |
| "谈判出多少价" | LLM | ❌ 公式计算 | 价格由Agent角色扮演产生 |
| "首付够不够" | 代码 (规则) | - | `check_affordability` |
| "转账和过户" | 代码 (规则) | - | `execute_transaction` |

---

## 二、性能优化: 漏斗式 Pipeline (减少LLM调用)

为避免LLM负担过重，项目采用 **"代码预筛选 + LLM精准决策"** 的分层策略：

```
┌───────────────────────────────────────────────────────────┐
│ 层级 1: SQL 快速筛选 (0 Token)                            │
│ ──────────────────────────────────────────────────────── │
│ 从 agents_finance 筛选 [现金 > X 或 收入 > Y] 的候选者     │
│ 排除极端无能力者（如现金<5万且无房产）                    │
│ 结果: 从 10000 人 → 500 人                                │
└───────────────────────────────────────────────────────────┘
                          ↓
┌───────────────────────────────────────────────────────────┐
│ 层级 2: LLM 批量角色判定 (少量 Token)                     │
│ ──────────────────────────────────────────────────────── │
│ 对 500 人进行 batched_determine_role                      │
│ 一次 LLM 调用处理 10-50 人的角色判定                      │
│ 结果: 从 500 人 → 50 人激活 (BUYER/SELLER)                │
└───────────────────────────────────────────────────────────┘
                          ↓
┌───────────────────────────────────────────────────────────┐
│ 层级 3: LLM 个体决策 (精准 Token)                         │
│ ──────────────────────────────────────────────────────── │
│ 仅对 50 个激活者进行详细交互:                             │
│   - generate_seller_listing (卖家定价)                    │
│   - match_property_for_buyer → LLM选房 (新)               │
│   - negotiate (谈判)                                      │
└───────────────────────────────────────────────────────────┘
```

### 2.1 Token 消耗估算 (1万Agent, 1个月)

| 阶段 | 调用次数 | 每次Token | 总Token |
|:-----|:---------|:----------|:--------|
| 层级1: SQL筛选 | 0 | 0 | **0** |
| 层级2: 批量判定 | 10批×50人 | ~1000 | **10,000** |
| 层级3: 卖家定价 | 20卖家 | ~500 | **10,000** |
| 层级3: 买家选房 | 30买家 | ~600 | **18,000** |
| 层级3: 谈判 | 15对 | ~1500 | **22,500** |
| **总计** | - | - | **~60,000** |

对比无优化场景 (对1万人逐个LLM判定): **1000万+ Token**

---

## 三、开发红线 (Coding Do & Don't)

### ✅ DO (正确做法)

```python
# 让LLM从候选列表中选择
prompt = f"你是买家{buyer.name}，以下房源符合预算：{candidates}。你最想买哪套？"
result = safe_call_llm(prompt, default=candidates[0])

# 将约束转为上下文提示
prompt = f"""
你的现金只剩{agent.cash}元，仅够维持2个月。
【提示】你可能需要考虑变卖资产，但最终由你决定。
"""
```

### ❌ DON'T (错误做法)

```python
# 代码强制决策 (Bad)
if agent.cash < agent.monthly_income * 2:
    return AgentRole.SELLER  # ← 代码替Agent做了决定

# 代码替Agent选房 (Bad)
candidates.sort(key=lambda x: x['price'])
return candidates[0]  # ← 最便宜的不一定是Agent想要的
```

---

## 四、如何确保规则全局生效

1. **本文件位置**: `d:\GitProj\oasis-main\AGENTS.md`
2. **AI读取机制**: AI助手在开始工作前应读取此文件
3. **代码审计**: 任何修改需检查是否违反 Section 1 原则
4. **PR Checklist**: 新功能需回答 "这是LLM决策还是代码规则？"

---

## 五、参考文档

- [project_rules_v2_draft.md](file:///C:/Users/wyl/.gemini/antigravity/brain/d98570f7-e95c-483c-9acf-b367cee12fee/project_rules_v2_draft.md) - V2完整规则百科
- [architecture_audit.md](file:///c:/Users/wyl/.gemini/antigravity/brain/8ddb714d-68f2-46e6-9924-9afd19a6b338/architecture_audit.md) - 当前违规项清单
