这份需求文档旨在将 Oasis 社交仿真系统重构为深度受大语言模型（LLM）驱动的**房地产经济沙盘**。我们将核心逻辑从“社交互动”转向“基于生命周期的资产配置”。

---

## 1. 系统核心架构与确权机制

在 `oasis_realestate` 模块中，所有权和价值确认是交易的基石。

### 1.1 房产登记簿 (Property Registry/Ledger)

系统必须维护一个不可变（Immutable）的属性表，作为物理资产的唯一事实来源：

* **权属登记 (`owner_id`)**: 记录房产当前法定持有者（Agent ID 或系统）。
* **实物特征**:
* `quality`: 1（低）、2（中）、3（高），对应不同的价值锚点。
* `zone`: A（核心）、B（次核心）、C（边缘），决定增值潜力和学区属性。


* **状态机**: 房产在 `off_market`（自住/持筹）和 `for_sale`（挂牌）之间切换。

### 1.2 资产价值确认

* **锚点价格**: 系统预设基准价（如 A区 3 级品质 > 500w）。
* **挂牌价 (`listed_price`)**: 卖家基于 LLM 决策后的主观要价。
* **成交价**: 撮合引擎根据买卖双方博弈确定的最终合同价。

---

## 2. Agent 身份转换逻辑 (Role Transition)

每个 Agent 不再有固定标签，其身份（买家/卖家/观望者）是**每一步长（Step）根据其背景属性由 LLM 动态推导的结果**。

### 2.1 Agent 背景画像表 (Profile)

为了让 7B 模型能“掷好色子”，必须输入以下结构化背景：
| 维度 | 属性示例 | 作用 |
| :--- | :--- | :--- |
| **经济实力** | 现金、月薪、职业稳定性、信用评分 | 决定贷款额度和抗风险能力 |
| **生命周期** | 年龄、婚姻状况（未婚/订婚/已婚）、子女数量/年龄 | 驱动置换（卖小换大）或学区刚需 |
| **性格倾向** | 风险偏好（理性/感性）、学历、社交圈层压力值 | 决定是否受市场恐慌/贪婪情绪影响 |
| **资产现状** | 持有房产数量、当前负债率（LTV） | 决定其是否具备成为卖家的动机 |

---

## 3. LLM 驱动的决策逻辑 (Decision Engine)

这是系统的核心，通过 LLM 模拟人类非理性的决策过程。

### 3.1 卖方决策逻辑：为什么卖？

LLM 接收当前 Agent 背景和市场信息，在以下动机中“掷色子”：

1. **置换驱动**: “孩子快上小学了，现在的 B 区房子品质不够，我必须卖掉它凑 A 区的首付。”
2. **变现驱动**: “我最近失业了/行业不景气，现金流不足以覆盖 3% 的利率月供，我必须止损。”
3. **获利了结**: “我认为房价已达顶峰（高于心理预期 1.5 倍），我要套现离场。”

### 3.2 买方决策逻辑：为什么买？

1. **刚需锚点**: “我要结婚，没有房产在我的社交圈中意味着失败。”
2. **资产避险**: “现金在贬值，我虽然觉得房价高，但买入房产是唯一的抗通胀手段。”
3. **投机逐利**: “房价连续 3 个月上涨，我预期下个月还会涨。”

### 3.3 观望者决策逻辑

* 由于“钱不够”或“预期未来会跌”而选择持有现金，保持不活跃状态。

---

## 4. 交易与撮合机制 (Trading Engine)

### 4.1 撮合流程

1. **提交指令**: LLM 输出 Action（`List` / `Bid` / `Wait`）。
2. **订单簿 Snaphot**: 系统收集所有 `market_order`，包括 `property_id` 和 `price`。
3. **清算逻辑 (Clearing)**:
* **价格优先**: 高出价买家优先。
* **资金核验**: 检查买家现金是否满足 30% 首付。
* **确权更新**: 扣除首付，更新 `property.owner_id`，记录 `transaction_history`。



---

## 5. 工程实现建议

建议采用 **“思考与执行分离”** 的策略：

1. **Inner Monologue (内心独白)**:
* 让 LLM 先输出一段话：“我看到 A 区价格涨得厉害，我虽然钱不多，但我怕再不买就买不起了。”
* 这保证了您想要的“决策想法”可见。


2. **JSON 指令集**:
* 强制 LLM 在最后输出：`{"action": "bid", "target": "prop_123", "price": 4500000}`。


3. **分批推理 (Batch Processing)**:
* 针对 100 万 Agent，不要逐一调用。利用 7B 模型的 Batch 特性，一次处理 16-32 个 Agent 的背景数据，提高本地显卡的利用率。



 ## 6.Prompt 模板”**
为了让 7B 级别的本地模型（如 Llama-3-8B 或 Mistral-7B）在扮演虚拟角色时既能展现出“非理性的决策想法”，又能稳定地输出程序可解析的交易指令，我们需要设计一个**结构化推理（Chain-of-Thought）提示词模板**。

以下是为您设计的提示词框架及配套的需求实现逻辑：

---

## 1. 7B 模型专用：房地产决策提示词模板 (Prompt Template)

这个模板建议采用 `System Message` + `User Message` 的结构。

### System Prompt (设定世界观与规则)

> 你现在是 Oasis 虚拟房地产沙盘中的一个 Agent。
> 你的目标是根据自己的背景、家庭需求和财务状况做出每月的房产决策。
> 你可以决定：**买房 (BUY)**、**卖房 (SELL)** 或 **观望 (WAIT)**。
> **注意**：
> 1. 房产分为 A（核心）、B（次核心）、C（边缘）三个区域。
> 2. 房产质量分为 1（低）、2（中）、3（高）。
> 3. 贷款首付比例固定为 30%，年利率 3%。
> 4. 你的决策不必总是完全理性的，你可以受到焦虑、面子、对未来的恐惧或贪婪的影响。
> 
> 

### User Prompt (Agent 当前状态快照)

> **【你的基本资料】**
> * 姓名/ID: {agent_id}
> * 年龄: {age} | 婚姻状况: {marital_status} | 子女: {children_count}
> * 职业: {job_title} | 收入: {income}/月 | 性格倾向: {personality}
> * 资产: 现金 {cash}w | 持有房产: {owned_properties_list}
> 
> 
> **【当前市场观测】**
> * 市场均价趋势: {market_trend} (过去3个月变化: {trend_percentage})
> * 正在出售的房产清单: {market_listings} (包含 ID, 区域, 品质, 挂牌价)
> 
> 
> **【生活变故/心理暗示】**
> * {life_event_trigger} (例如：孩子快上小学了，急需学区；或者公司传闻要裁员)
> 
> 
> **【你的任务】**
> 第一步：请以第一人称写出你的**心理活动 (Inner Monologue)**，分析你的压力、需求和对市场的看法。
> 第二步：根据分析，给出你的决策结论，必须严格遵守以下 JSON 格式：
> ```json
> {
>   "action": "BUY/SELL/WAIT",
>   "target_id": "房产ID/null",
>   "price": 数值/null,
>   "reason_code": "置换/刚需/避险/套现/恐慌"
> }
> 
> ```
> 
> 

---

## 2. 核心逻辑实现：房产登记簿与身份转换

为了配合 LLM 的决策落地，后端需要构建以下三个关键组件：

### 2.1 动态房产登记簿 (The Ledger)

不仅仅是一个静态表，而是一个记录“权属流转”的日志。

* **权属校验**：当 Agent 提交 `SELL` 指令时，系统必须校验其 `owner_id` 是否匹配。
* **价值锚点与偏差**：登记簿记录房产的“物理价值”（Base Value），而 `market_order` 记录 Agent 的“心理出价”。

### 2.2 身份转换状态机

Agent 的身份在每个 Step 结束时根据资产负债表自动刷新：

* **潜在买家 (Potential Buyer)**：现金 > 0 且房产数量 < 需求阈值。
* **潜在卖家 (Potential Seller)**：持有房产且（现金流断裂 或 满足置换条件）。
* **观望者 (Observer)**：在本步长内 LLM 选择 `WAIT` 的 Agent。

### 2.3 交易撮合机制 (Matching Logic)

对于 7B 模型产生的“掷色子”结果，系统按以下顺序处理：

1. **收集出价**：汇总本步长内所有 `BUY` 和 `SELL` 指令。
2. **初步筛选**：剔除首付不足或目标房产已下架的无效订单。
3. **竞争模拟**：若多个买家竞争同一房产，系统模拟“价高者得”或“随机抽取”（体现现实中的摇号或抢房）。
4. **清算确权**：更新 `property` 表所有者信息，并向双方发送 Transaction Log。

---

## 3. 落地建议：如何让 100 万 Agent “跑起来”

在 7B 模型环境下，要实现您的 5 年（60 个月）模拟，建议采取以下**工程优化**手段：

* **关键路径激活**：并非 100 万个 Agent 每个月都要调用 LLM。只有触发了“生活事件”（如结婚、收入变化、市场暴涨跌）的 Agent 才调用 LLM 深度决策。其他 Agent 使用简单的概率模型（Heuristics）快速滑动。
* **异步推理池**：使用 vLLM 或 TGI 等推理加速框架，开启 Continuous Batching，将 Agent 的 Prompt 成批送入显卡。
* **心理压力指标 (Anxiety Score)**：在数据库中增加一个 `anxiety_level` 字段。如果 LLM 在内心独白中提到“非常焦虑”，则提高其在下一轮决策中的“非理性系数”（例如提高出价上限）。

**您觉得这个 Prompt 模板是否捕获了您想要的“人味儿”？如果需要，我可以为您进一步设计“生活变故触发器（Life Event Generator）”的逻辑方案。**